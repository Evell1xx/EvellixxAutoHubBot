import requests
import time
import os

TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
API = f"https://api.telegram.org/bot{TOKEN}"

VERSIONS = {
    "free": {
        "name": "Voyah Free",
        "versions": {
            "1.3.12": " VOYAH OS 1.3.12 — описание обновления
            Общая информация
Версия: 1.3.12
Дата: 05.12.2023
Время установки: ~10 минут
Тип обновления: первый этап двухэтапного OTA (1.3.12 → 1.3.13)
Данная версия является подготовительным обновлением, после которого автоматически предлагается установка версии 1.3.13 для получения полного функционала.
Кратко о версии
Обновление 1.3.12 открывает доступ к новому OTA-пакету и подготавливает систему автомобиля к следующему этапу.
После завершения этого обновления пользователю в кратчайшие сроки предлагается установка версии 1.3.13, в которой активируются все заявленные функции.
1. Добавлен поиск парковочного места в R-режиме для автопарковки
В систему автоматической парковки добавлена возможность поиска парковочного места при движении задним ходом.
Это расширяет сценарии использования автопарковки и упрощает манёвры в стеснённых условиях.
2. Оптимизирована работа зарядки
Улучшена логика зарядного процесса:
более стабильный запуск зарядки;
уменьшено количество сбоев;
повышена надёжность работы системы в целом.
3. Улучшена работа Bluetooth-музыки
Повышена плавность воспроизведения аудио по Bluetooth:
снижены задержки;
уменьшено количество разрывов соединения;
улучшена стабильность при длительном воспроизведении.
4. Оптимизировано сетевое соединение
Система стала устойчивее к колебаниям сигнала:
стабильнее интернет-подключение;
корректнее работа онлайн-сервисов;
снижено количество сетевых ошибок.
5. Прочие оптимизации контроллеров автомобиля
Выполнены дополнительные внутренние улучшения электронных блоков управления, направленные на повышение стабильности и надёжности автомобиля.  Особенности обновления
это первый этап OTA-обновления;
для получения полного функционала требуется установка версии 1.3.13;
условия установки стандартные: заряд батареи не ниже 30%, без зарядки, автомобиль закрыт;
при сбое обновление можно повторно запланировать.
 Итог
VOYAH OS 1.3.12 — подготовительное обновление, которое:
открывает доступ к новым функциям OTA;
подготавливает систему к версии 1.3.13;
улучшает стабильность зарядки, Bluetooth и сети;
является обязательным шагом для полного обновления.",
            "1.3.13": "VOYAH OS 1.3.13 — описание обновления
 Общая информация
Версия: 1.3.13
Дата: 12.12.2023
Время установки: ~1 час 06 минут
Рекомендуемое время выполнения: ночное (например, 02:00)
Обновление содержит первые заметные пользовательские улучшения, затрагивающие парковку, зарядку и мультимедиа.
1. Добавлен поиск парковочного места в R-режиме для автопарковки
Система автоматической парковки теперь умеет искать подходящее парковочное место при движении задним ходом.
Это повышает удобство парковки в ограниченных пространствах и при сложных манёврах.
2. Оптимизирована работа зарядки
Улучшена логика зарядного процесса:
стабильнее старт зарядки;
меньше ошибок и прерываний;
корректнее отображается статус зарядки.
Повышен общий комфорт при ежедневной эксплуатации.
3. Улучшена работа Bluetooth-музыки
Оптимизировано воспроизведение аудио по Bluetooth:
уменьшены задержки;
снижено количество разрывов соединения;
более плавное переключение треков.
Музыка воспроизводится стабильнее, особенно при длительных поездках.
4. Повышена стабильность сетевого соединения
Оптимизирована работа сетевых модулей автомобиля:
устойчивее соединение с интернетом;
меньше обрывов при слабом сигнале;
стабильнее работа онлайн-сервисов.
5. Прочие оптимизации контроллеров автомобиля
Выполнен ряд внутренних улучшений электронных блоков управления, направленных на повышение общей стабильности и надёжности системы.
 Условия выполнения обновления
заряд батареи не ниже 30%;
не подключать зарядку во время обновления;
автомобиль должен быть заперт;
во время обновления автомобиль недоступен для использования;
при сбое обновление можно повторно запланировать.
 Итог
VOYAH OS 1.3.13 — важный шаг в развитии функциональности:
автопарковка стала удобнее;
улучшены зарядка и Bluetooth;
повышена стабильность сетевых сервисов;
заложена база для дальнейших OTA-обновлений."
        }
    },
    "dream": {
        "name": "Voyah Dream",
        "versions": {
        
        }
    }
}

def send_message(chat_id, text, reply_markup=None):
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "HTML"
    }
    if reply_markup:
        payload["reply_markup"] = reply_markup
    requests.post(f"{API}/sendMessage", json=payload)

def edit_message(chat_id, message_id, text, reply_markup=None):
    payload = {
        "chat_id": chat_id,
        "message_id": message_id,
        "text": text,
        "parse_mode": "HTML"
    }
    if reply_markup:
        payload["reply_markup"] = reply_markup
    requests.post(f"{API}/editMessageText", json=payload)

def models_keyboard():
    return {
        "inline_keyboard": [
            [{"text": v["name"], "callback_data": f"model:{k}"}]
            for k, v in VERSIONS.items()
        ]
    }

def versions_keyboard(model_key):
    model = VERSIONS[model_key]
    return {
        "inline_keyboard": [
            [{"text": ver, "callback_data": f"ver:{model_key}:{ver}"}]
            for ver in model["versions"]
        ]
    }

def handle_update(update):
    if "message" in update:
        msg = update["message"]
        chat_id = msg["chat"]["id"]
        text = msg.get("text", "")

        if text == "/versions":
            send_message(
                chat_id,
                "Выберите модель автомобиля:",
                models_keyboard()
            )

    elif "callback_query" in update:
        cq = update["callback_query"]
        data = cq["data"]
        chat_id = cq["message"]["chat"]["id"]
        msg_id = cq["message"]["message_id"]

        if data.startswith("model:"):
            model_key = data.split(":")[1]
            model = VERSIONS[model_key]

            edit_message(
                chat_id,
                msg_id,
                f"<b>{model['name']}</b>\nВыберите версию:",
                versions_keyboard(model_key)
            )

        elif data.startswith("ver:"):
            _, model_key, ver = data.split(":")
            desc = VERSIONS[model_key]["versions"][ver]

            send_message(
                chat_id,
                f"<b>{VERSIONS[model_key]['name']} {ver}</b>\n\n{desc}"
            )

def main():
    offset = 0
    while True:
        resp = requests.get(
            f"{API}/getUpdates",
            params={"timeout": 30, "offset": offset}
        ).json()

        for update in resp.get("result", []):
            offset = update["update_id"] + 1
            handle_update(update)

        time.sleep(1)

if __name__ == "__main__":
    main()
